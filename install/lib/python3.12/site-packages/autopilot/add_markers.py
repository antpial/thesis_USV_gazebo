#!/usr/bin/env python3
import sys
import xml.etree.ElementTree as ET
import math



def read_kml_coordinates(filename):
    tree = ET.parse(filename)
    root = tree.getroot()

    # przestrze≈Ñ nazw w KML
    ns = {"kml": "http://www.opengis.net/kml/2.2"}

    coords = []
    for placemark in root.findall(".//kml:Placemark", ns):
        name = placemark.find("kml:name", ns).text
        coord_text = placemark.find(".//kml:coordinates", ns).text.strip()
        lon, lat, *alt = map(float, coord_text.split(","))
        coords.append((name, lon, lat, alt[0] if alt else 0.0))
    return coords


def approx_enu(lat, lon):
    lat0 = -33.724223
    lon0 = 150.679736
    m_per_deg_lat = 111132.92 - 559.82 * math.cos(2*math.radians(lat0)) + 1.175 * math.cos(4*math.radians(lat0))
    m_per_deg_lon = 111412.84 * math.cos(math.radians(lat0)) - 93.5 * math.cos(3*math.radians(lat0))
    d_lat = lat - lat0
    d_lon = lon - lon0
    north = d_lat * m_per_deg_lat
    east  = d_lon * m_per_deg_lon
    return east, north


def generate_marker_sdf(x=-533, y=165.0, z=0.0, radius=5.0, length=2.0,
                        r=0, g=1, b=0, a=0.5,
                        filename="/home/antoni/gazebo_maritime_ws/src/gazebo_maritime/worlds/markers.sdf"):
    sdf_content = f"""<?xml version="1.0"?>
<!-- Autogenerated file by src/autpilot/autopilot/add_markers.py to visualize checkpoints -->
<sdf version="1.9">
<model name="marker_cylinder">
    <pose>{x} {y} {z} 0 0 0</pose>
    <static>true</static>
    <link name="link">
    <visual name="visual">
        <geometry>
        <cylinder>
            <radius>{radius}</radius>
            <length>{length}</length>
        </cylinder>
        </geometry>
        <material>
        <ambient>{r} {g} {b} {a}</ambient>
        <diffuse>{r} {g} {b} {a}</diffuse>
        </material>
    </visual>
    </link>
</model>
</sdf>
"""
    with open(filename, "w") as f:
        f.write(sdf_content)
    print(f"File '{filename}' generated!")

if __name__ == "__main__":
    filename = "/home/antoni/gazebo_maritime_ws/src/autopilot/autopilot/checkpoints_list.kml"
    points = read_kml_coordinates(filename)
    x, y = approx_enu(points[0][2], points[0][1])
    generate_marker_sdf(x,y)
